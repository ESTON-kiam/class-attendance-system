{% extends "attendance_app/base.html" %}

{% block title %}Register Student{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2>Register New Student</h2>
    
    <!-- Display error messages -->
    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{% if message.tags == 'error' %}danger{% else %}{{ message.tags }}{% endif %}">
                {{ message }}
            </div>
        {% endfor %}
    {% endif %}
    
    <form method="post" enctype="multipart/form-data">
        {% csrf_token %}
        <div class="mb-3">
            <!-- Webcam capture section -->
            <div class="mb-3">
                <label class="form-label">Capture Photo</label>
                <div class="mb-2">
                    <video id="video" width="320" height="240" autoplay class="border rounded"></video>
                </div>
                <div class="mb-2">
                    <canvas id="canvas" width="320" height="240" class="border rounded d-none"></canvas>
                </div>
                <button type="button" id="capture" class="btn btn-info">Capture Photo</button>
                <button type="button" id="retake" class="btn btn-warning d-none">Retake</button>
                <input type="hidden" id="photo_data" name="photo_data">
            </div>
            
            <!-- Form fields with error highlighting -->
            {% for field in form %}
                {% if field.name != 'photo' and field.name != 'photo_data' %}
                    <div class="mb-3">
                        <label for="{{ field.id_for_label }}" class="form-label">{{ field.label }}</label>
                        {{ field }}
                        {% if field.errors %}
                            <div class="text-danger">
                                {% for error in field.errors %}
                                    <small>{{ error }}</small>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                {% endif %}
            {% endfor %}
        </div>
        <button type="submit" class="btn btn-primary">Register</button>
        <a href="{% url 'student_list' %}" class="btn btn-secondary">Cancel</a>
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const capture = document.getElementById('capture');
    const retake = document.getElementById('retake');
    const photoData = document.getElementById('photo_data');
    
    // Access webcam
    if(navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
        navigator.mediaDevices.getUserMedia({ video: true })
            .then(function(stream) {
                video.srcObject = stream;
            })
            .catch(function(error) {
                console.error("Error accessing webcam:", error);
                alert("Could not access webcam. Please check permissions.");
            });
    }
    
    // Capture photo
    capture.addEventListener('click', function() {
        canvas.width = 320;
        canvas.height = 240;
        canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);
        
        // Convert to data URL and set as hidden input
        photoData.value = canvas.toDataURL('image/jpeg', 0.8);
        
        // Show canvas and retake button
        canvas.classList.remove('d-none');
        retake.classList.remove('d-none');
        capture.classList.add('d-none');
    });
    
    // Retake photo
    retake.addEventListener('click', function() {
        photoData.value = '';
        canvas.classList.add('d-none');
        retake.classList.add('d-none');
        capture.classList.remove('d-none');
    });
});
</script>
{% endblock %}